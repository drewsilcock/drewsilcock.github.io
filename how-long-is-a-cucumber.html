<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- Canonical link, apparently needed for https -->
  <link rel="canonical" href="https://www.drewsilcock.co.uk/how-long-is-a-cucumber" />

  <title>
    
      How long is a cucumber? ğŸ¥’ &middot; Drew Silcock
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/stylesheets.css">

  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="57x57" href="/public/media/icons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/public/media/icons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/media/icons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/public/media/icons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/public/media/icons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/public/media/icons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/media/icons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/public/media/icons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/media/icons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/public/media/icons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/public/media/icons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/public/media/icons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/public/media/icons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/public/media/icons/manifest.json">
  <link rel="mask-icon" href="/public/media/icons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/public/media/icons/mstile-144x144.png">
  <meta name="theme-color" content="#ac4142">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52653050-1', 'auto');
  ga('send', 'pageview');

</script>


  <body class="theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>new Stream(consciousness)</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/download/">Download</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/projects/">Projects</a>
        
      
    
      
        
      
    
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="https://github.com/drewsberry">GitHub Profile</a>
    <span class="sidebar-nav-item">Currently v1.2.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2018. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Drew Silcock</a>
            <small>Nebulous thoughts</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">How long is a cucumber? ğŸ¥’</h1>
  <span class="post-meta">
      <span class="post-date">
          20 Dec 2018
      </span>
      <div class="post-meta-separator">
          &#x2016;
      </div>
      <span class="post-categories">
          <a href="/archive/#coding">
              Coding
          </a>
      </span>
  </span>
  <p><em>Or: UTF16 handling of astral planes and implications for JavaScript string indexing</em></p>

<p><strong>tldr</strong>: 2.</p>

<p>String encoding in JavaScript is a bit weird. You mightâ€™ve heard this before. You might even have read about how, somewhat inexplicably, JavaScript does not use the almost universal UTF8 file encoding but instead UTF16<sup>*</sup>. In this article Iâ€™m going to explore some of the more subtle and perplexing aspects of the weird way JavaScript encodes its strings, and what this means for common operations like string indexing.</p>

<h2 id="so-whats-all-this-unicode-stuff-about-then">So whatâ€™s all this Unicode stuff about then?</h2>

<p><em>(If youâ€™re already a Unicode wizard, go ahead and skip to the <a href="#so-what-does-this-have-to-do-with-javascript-and-cucumberscucumber">next section</a>.)</em></p>

<p>Well, Unicode is a standard for defining characters like â€˜Fâ€™, â€˜â™¡â€™ or â€˜ğŸ¥’ â€˜. (if you all you see is a blank box for this, just mentally replace it with another character like â˜¸). The way it does this is by giving each character a corresponding â€˜â€˜code pointâ€™â€™ which is a numerical value like <code>135</code> (which happens to be this character: â€¡). Usually, this numerical value is represented hexademically, meaning â€¡ corresponds to code point <code>0x87</code>.</p>

<p>The Unicode standard has a total of 1,114,112 code points, corresponding to 1,114,112 possible characters<sup>**</sup>. Thatâ€™s a lot of characters. To split this up, this space is divided into 17 â€˜â€˜planesâ€™â€™, where each plane has 65,535 (or 2<sup>16</sup>) code points. The first plane, which contains most of the commonly used characters like â€˜â€˜9â€™â€™, â€˜â€˜Â£â€™â€™, â€˜â€˜Úâ€™â€™ and â€˜â€˜ä¸§â€™â€™, is called the Basic Multilingual Plane (or BMP). This contains all of ASCII and extended ASCII; African, Middle-Eastern and non-Latin European scripts; Chinese, Japanese and Korean characters (collectively referred to as CJK characters); private use and what are known as â€˜â€˜surrogate pairsâ€™â€™. Iâ€™ll come onto what exactly surrogate pairs are used for a bit later.</p>

<p>Past this continent of common characters lies the vast, largely uninhabited and mysterious realms known as the 16 â€˜â€˜astral planesâ€™â€™ (or â€˜â€˜supplementary planesâ€™â€™, if youâ€™re being boring).</p>

<p>The BMP takes up the first 2<sup>16</sup> code points in the range <code>0x0000</code> to <code>0xffff</code>. This means that all BMP code points can be represented using only 16 bits or 2 bytes (some fewer). The astral planes, extending from <code>0x10000</code> to the full <code>0x10ffff</code>, need between 3 and 4 bytes to represent them.</p>

<p><img src="/public/media/how-long-is-a-cucumber/astral_planes.jpg" alt="The 14&lt;sup&gt;th&lt;/sup&gt; Century philosopher Nicole Oresmo's astral planes." /></p>

<blockquote>
  <p>The 14<sup>th</sup> Century philosopher Nicole Oresmo demonstrates some astral plane characters. Images such as these would be distributed to the monks of the monasteries to aid their copying of Unicode manuscripts.</p>
</blockquote>

<h3 id="so-what-does-this-have-to-do-with-javascript-and-cucumbers">So what does this have to do with JavaScript and cucumbers?</h3>

<p>Well, among the vast expanse of astral code points lies the cucumber, code point <code>0x1f952</code>: ğŸ¥’ . Because the cucumber character is above the BMP, it needsmore than 16 bits to represent it. Yet, JavaScript uses UTF16 which encodes each character using only <em>16</em> bits, so how does this work?!</p>

<p>The truth is that UTF16 essentially uses two separate code points to represent this single character. This is where the â€˜â€˜surrogateâ€™â€™ code points that I mentioned earlier come in. Unicode reserves two blocks, the â€˜â€˜High Surrogatesâ€™â€™: <code>0xd800</code> - <code>0xdbff</code> and the â€˜â€˜Low Surrogatesâ€™â€™: <code>0xdc00</code> - <code>0xdfff</code>.</p>

<p>Each astral code point is represented in UTF16 as one Low Surrogate and one High Surrogate by the following equation:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><a name="True-1"></a><span class="mh">0x1000016</span> <span class="o">+</span> <span class="p">(</span><span class="nx">high_surrogate</span> <span class="err">âˆ’</span> <span class="mh">0xd80016</span><span class="p">)</span> <span class="err">Ã—</span> <span class="mh">0x40016</span> <span class="o">+</span> <span class="p">(</span><span class="nx">low_surrogate</span> <span class="err">âˆ’</span> <span class="mh">0xdc0016</span><span class="p">)</span></code></pre></figure>

<p>What this means is that, in JavaScript, the cucumber character <code>0x1f952</code> is represented as <em>two separate characters</em>: <code>55358</code> or <code>0xd83e</code> (the high surrogate) and <code>56658</code> or <code>0xdd52</code> (the low surrogate).</p>

<h3 id="okay-so-what-does-this-mean-for-string-indexing">Okay, so what does this mean for string indexing?</h3>

<p>The astute reader may wonder what these surrogate pair representations of single characters means for the indexing of strings in JavaScript. When you have a string like <code>var s = "hello there"</code>, you expect <code>s[0]</code> to give you the first character, <code>s[3]</code> to give you the fourth character and <code>s[7]</code> to give you the eight character. But what about the following code:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><a name="True-1"></a><span class="kd">var</span> <span class="nx">cucumber</span> <span class="o">=</span> <span class="s2">&quot;ğŸ¥’&quot;</span><span class="p">;</span>
<a name="True-2"></a><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cucumber</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<a name="True-3"></a><span class="c1">// -&gt; 2</span></code></pre></figure>

<p>So, even though it contains only a single character, JavaScript thinks that the cucumber string has a length of 2! We can delve a bit further:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><a name="True-1"></a><span class="kd">var</span> <span class="nx">highSurrogate</span> <span class="o">=</span> <span class="nx">cucumber</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="True-2"></a><span class="kd">var</span> <span class="nx">lowSurrogate</span> <span class="o">=</span> <span class="nx">cucumber</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="True-3"></a>
<a name="True-4"></a><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">highSurrogate</span><span class="p">,</span> <span class="nx">highSurrogate</span><span class="p">.</span><span class="nx">codePointAt</span><span class="p">());</span>
<a name="True-5"></a><span class="c1">// -&gt; ï¿½ 55358</span>
<a name="True-6"></a><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">lowSurrogate</span><span class="p">,</span> <span class="nx">lowSurrogate</span><span class="p">.</span><span class="nx">codePointAt</span><span class="p">());</span>
<a name="True-7"></a><span class="c1">// -&gt; ï¿½ 56658</span></code></pre></figure>

<p>What this shows is that string indexing works by assuming that all characters are within the BMP, and so are exactly 16 bits long. So the indexing picks out not the entire cucumber character, but only one of its two surrogate pairs!</p>

<p>This means that the string indexing works the same way as classical C-like array indexing, where <code>s[4]</code> just means getting the address of <code>s</code> and skipping forward <code>4 * sizeof s[0]</code> bytes.</p>

<p>This maintains the O(1) speed of normal BMP string indexing, but is clearly bound to cause bugs when users are able to input astral characters into a script not expecting it! In fact, as I type out this article on http://dillinger.io, trying to remove an astral character with the â€˜â€˜Deleteâ€™â€™ or â€˜â€˜Backspaceâ€™â€™ buttons on a character like â€˜â€˜ğŸ˜Šâ€™â€™ deletes not the character, but one of the <em>surrogates</em>, leaving the other surrogate as a weird question mark (ï¿½) which really confuses the cursor positioningâ€¦</p>

<p>(Itâ€™s also a fun way to trick password forms into accepting fewer characters than they were asking for, like â€˜â€˜ğŸ˜‚ğŸ˜¼ğŸ˜ŠâœŒï¸â€™â€™ which will trick JavaScript minimum character checks looking for a minimum of 8 characters.)</p>

<h3 id="what-about-this-utf-8-business-then">What about this UTF-8 business then?</h3>

<p>UTF-8 is a variable-length encoding, which means that there are no surrogate pairs and instead each character has a variable length; ASCII character are only 1 byte long, but the CJK characters are 2 bytes long. The astral code points extend to 3 and 4 bytes. What this means is that, whereas UTF16 tries (in vain) to maintain a 16-bit limit on characters, UTF8 characters are by design non-fixed size.</p>

<p>UTF-8 strings are always smaller (or same size as) UTF-16 or UTF-32 strings, which makes them the most compact Unicode encoding.</p>

<h3 id="so-how-do-other-languages-handle-unicode">So how do other languages handle Unicode?</h3>

<p>Well, JavaScript isnâ€™t on its own:</p>

<ul>
  <li><strong>C</strong> - natively uses 8-bit <code>char</code> able to handle only the ASCII character set. C99 introduced <code>wchar_t</code> meaning a 16-bit wide characters able to handle all Unicode via the surrogate pair method used by JavaScript (just donâ€™t try to implement this yourself unless you are <em>really really</em> into this kind of thing).</li>
  <li><strong>C++</strong> - natively uses 8-bit <code>std::string</code> much like pure C. There is <code>std::wstring</code> analogous to Câ€™s <code>wchar_t</code> with corresponding <code>std::wcout</code>, <code>std::wcerr</code>, etc.</li>
  <li><strong>Python</strong> - Iâ€™m not going to open this can of worms. To summarise, Python supports the full Unicode range via either UTF-16 (as per JavaScript) or UCS-4 which is where each character is 32-bits long and you donâ€™t have to deal with any of this surrogate nonsense (although all your strings end of being <em>much</em> larger than they need to be).</li>
  <li><strong>Java</strong> - Javaâ€™s <code>char</code> type is 16-bit length able to store the BMP characters only. The <code>String</code> type uses UTF-16 to enable the full Unicode range as per JavaScript.</li>
</ul>

<p>Then again, some of the newer languages seem to have seen the errors of the past and are adapting UTF-8 for strings natively:</p>

<ul>
  <li><strong>Go</strong> - Go source code is formatted as UTF-8. Strings are actually encoding-independent slices of bytes, however as Go source code is UTF-8 this practically means that almost all string literals are UTF-8. Indexing does <em>not</em>, however, index into the <em>runes</em> (i.e. visible characters) but the <em>bytes</em>. Bit weird, but there you go<sup>***</sup>.</li>
  <li><strong>D</strong> - has standard library support for UTF-8, UTF-16 <em>and</em> UTF-32 via <code>string</code>, <code>wstring</code> and <code>dstring</code> respectively, so youâ€™re spoilt for choice!</li>
  <li><strong>Rust</strong> - uses UTF-8 strings as standard - Rust source code is UTF-8, string literals are UTF-8, the <code>std::string::String</code> encapsulates a UTF-8 string and primitive type <code>str</code> (the borrowed counterpart to <code>std::string::String</code>) is always valid UTF-8. Nice!</li>
</ul>

<p>Check <a href="https://unicodebook.readthedocs.io/programming_languages.html">this link</a> out for more information about how different programming languages handle Unicode.</p>

<h3 id="bonus-round-utf8-string-indexing-in-rust">Bonus round: UTF8 string indexing in Rust</h3>

<p>While languages like Go embrace UTF-8 but maintain indexing into bytes as the default, Rust goes further in making string indexing work on <em>runes</em> instead of bytes.</p>

<p>This means that Rust eschews the traditional string O(1) indexing. The pro of this is that you get out of it what you actually <em>want</em>, which is the n<sup>th</sup> visible rune instead of the n<sup>th</sup> byte or 16-bit char. The con is that we lose our O(1) speed string indexing as we now have to look through each previous character to check the length before we get to our rune at n, making lookup O(n).</p>

<p><img src="/public/media/how-long-is-a-cucumber/string_encoding_visual.png" alt="A comparison of how UTF16 and UTF8 index strings." /></p>

<blockquote>
  <p>A visualisation of how UTF16 constructs strings compared to UTF8. The resulting UTF8 string is shorter, but indexing is not O(n) (as opposed to O(1)) due to the multi-byte nature of the UTF8 character.</p>
</blockquote>

<h3 id="aside-private-use-in-unicode">Aside: private use in Unicode</h3>

<p>What do you see when you look at the following symbol: â€˜î€€â€™?</p>

<p>Some people will see a weird â€˜pâ€™-like symbol. On Linux, you might see a tiny Tux, the friendly Linux mascot: <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Tux_Mono.svg/149px-Tux_Mono.svg.png" alt="Tux" /></p>

<p>Thatâ€™s because itâ€™s part of the â€œPrivate Use Areasâ€ of the Unicode standard. This means that these codepoints, <em>by definition</em>, will never have any characters assigned to them by the Unicode Consortium.</p>

<p><sup>*</sup> Technically, the <a href="http://es5.github.io/x2.html#x2">ECMAScript 5 specification</a> with which JavaScript is compliant specifies <em>either</em> UCS-2 <em>or</em> UTF16 for string encoding, but we wonâ€™t delve into this too much here. For more information on this subtle distinction, go read <a href="https://mathiasbynens.be/notes/javascript-encoding">this article</a>, itâ€™s really interesting if youâ€™re into your encoding.</p>

<p><sup>**</sup> In fact, the actual number of characters is significantly less than this for a few reasons:</p>

<ul>
  <li>137,468 code points are for â€˜â€˜private useâ€™â€™, meaning they will by definition never be assigned values by the Unicode Consortium.</li>
  <li>2,048 code points are used as â€˜â€˜surrogatesâ€™â€™. Iâ€™ll discuss surrogates when it comes to UTF16 in JavaScript later in this article.</li>
  <li>66 code points are specified as non-characters and used internally by programs. For example, the assigned non-character <code>0xFFFE</code> is used by programs to check whether theyâ€™ve got the endianness of a text file right, because the endian complement to <code>0xFFFE</code> is <code>0xFEFF</code>, which is the Byte Order Mark (BOM). If a program encounters <code>0xFFFE</code> at the start of a file, they it knows that theyâ€™ve got the endianess the wrong way around, because <code>0xFFFE</code> is <em>guaranteed</em> not to be used by the file as a character.</li>
</ul>

<p><sup>***</sup>See https://blog.golang.org/strings for more information on strings in Go.</p>


</div>

<hr>
<p><form action="/">
  <button class="btn btn-default btn-lg" href="/">
      Back to home...
  </button>
</form></p>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/jekyll-katex-block">
            Jekyll KaTeX Block
            <small>04 Nov 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/using-make-and-latexmk">
            Using make and latexmk for easy LaTeX compilation
            <small>23 Sep 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/calculating-overlap">
            Calculating the overlap of aerial photos
            <small>31 Jul 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>



    <!-- Message inviting everyone to comment -->
    <div class="discuss">
        If you liked this post, have any questions or fancy having a good discussion, please leave a comment below, or 
        <a href = "mailto:drewATdrewsilcockDOTcoDOTuk" 
           onclick = "this.href=this.href
                      .replace(/AT/,'&#64;')
                      .replace(/DOT/,'&#46;')
                      .replace(/DOT/,'&#46;')"
        >send me an email.</a>
    </div>

    <!-- Add Disqus comments -->
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'drewsilcock'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
 


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

  </body>

</html>

